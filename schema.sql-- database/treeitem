// src/components/DocumentTree.jsx - Update TreeItem component
function TreeItem({ 
  item, 
  level = 0, 
  onDocumentSelect, 
  onCreateDocument,
  onDeleteDocument,
  onDeleteFolder,
  onRenameDocument,
  onRenameFolder,
  onMoveDocument,
  currentDocumentId 
}) {
  const [isExpanded, setIsExpanded] = useState(true);
  const [isRenaming, setIsRenaming] = useState(false);
  const [newName, setNewName] = useState(item?.name || '');
  const [showMenu, setShowMenu] = useState(false);
  const [isDragOver, setIsDragOver] = useState(false);

  // Guard against undefined item
  if (!item || !item.id) {
    console.error('TreeItem received invalid item:', item);
    return null;
  }

  const isFolder = item.type === 'folder' || (item.children !== undefined && Array.isArray(item.children));
  const isDocument = item.type === 'document' || !item.children;
  const isActive = isDocument && item.id === currentDocumentId;

  const handleClick = (e) => {
    e.stopPropagation();
    if (isDocument && onDocumentSelect) {
      console.log('Selecting document:', item.id);
      onDocumentSelect(item);
    } else if (isFolder) {
      setIsExpanded(!isExpanded);
    }
  };

  const handleRename = () => {
    if (!newName.trim() || newName === item.name) {
      setIsRenaming(false);
      setShowMenu(false);
      return;
    }

    console.log('Renaming:', { id: item.id, newName, type: item.type });

    if (isDocument && onRenameDocument) {
      onRenameDocument(item.id, newName.trim());
    } else if (isFolder && onRenameFolder) {
      onRenameFolder(item.id, newName.trim());
    }
    
    setIsRenaming(false);
    setShowMenu(false);
  };

  const handleDelete = () => {
    setShowMenu(false);
    
    console.log('Deleting:', { id: item.id, type: item.type });

    if (isDocument && onDeleteDocument) {
      onDeleteDocument(item.id);
    } else if (isFolder && onDeleteFolder) {
      onDeleteFolder(item.id);
    }
  };

  const handleCreateDocInFolder = (e) => {
    e.stopPropagation();
    setShowMenu(false);
    
    console.log('Creating document in folder:', item.id);
    
    if (onCreateDocument) {
      onCreateDocument(item.id);
    }
  };

  // Drag and drop handlers
  const handleDragStart = (e) => {
    if (isDocument) {
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('documentId', item.id.toString());
      e.dataTransfer.setData('currentFolderId', (item.folder_id || 'null').toString());
      console.log('Drag start:', { documentId: item.id, folderId: item.folder_id });
    }
  };

  const handleDragOver = (e) => {
    if (isFolder) {
      e.preventDefault();
      e.stopPropagation();
      e.dataTransfer.dropEffect = 'move';
      setIsDragOver(true);
    }
  };

  const handleDragLeave = (e) => {
    e.stopPropagation();
    setIsDragOver(false);
  };

  const handleDrop = (e) => {
    e.preventDefault();
    e.stopPropagation();
    setIsDragOver(false);

    if (isFolder) {
      const documentId = parseInt(e.dataTransfer.getData('documentId'));
      const currentFolderId = e.dataTransfer.getData('currentFolderId');
      const targetFolderId = item.id;

      console.log('Drop on folder:', { documentId, currentFolderId, targetFolderId });

      if (currentFolderId !== targetFolderId.toString() && onMoveDocument && documentId) {
        onMoveDocument(documentId, targetFolderId);
      }
    }
  };

  return (
    <div className="tree-item-wrapper">
      <div
        className={`tree-item ${isActive ? 'active' : ''} ${isDragOver ? 'drag-over' : ''}`}
        style={{ paddingLeft: `${level * 20}px` }}
        onClick={handleClick}
        onContextMenu={(e) => {
          e.preventDefault();
          e.stopPropagation();
          setShowMenu(true);
        }}
        draggable={isDocument}
        onDragStart={handleDragStart}
        onDragOver={handleDragOver}
        onDragLeave={handleDragLeave}
        onDrop={handleDrop}
      >
        {isFolder && (
          <span 
            className="tree-toggle" 
            onClick={(e) => {
              e.stopPropagation();
              setIsExpanded(!isExpanded);
            }}
          >
            {isExpanded ? 'â–¼' : 'â–¶'}
          </span>
        )}
        
        <span className="tree-icon">
          {isFolder ? (isExpanded ? 'ğŸ“‚' : 'ğŸ“') : 'ğŸ“„'}
        </span>

        {isRenaming ? (
          <input
            type="text"
            className="tree-rename-input"
            value={newName}
            onChange={(e) => setNewName(e.target.value)}
            onBlur={handleRename}
            onKeyDown={(e) => {
              e.stopPropagation();
              if (e.key === 'Enter') {
                handleRename();
              }
              if (e.key === 'Escape') {
                setNewName(item.name);
                setIsRenaming(false);
                setShowMenu(false);
              }
            }}
            autoFocus
            onClick={(e) => e.stopPropagation()}
          />
        ) : (
          <span className="tree-name" title={item.name}>
            {item.name}
          </span>
        )}

        {/* Menu button - show for BOTH folders and documents */}
        <button
          className="tree-menu-btn"
          onClick={(e) => {
            e.stopPropagation();
            console.log('Menu button clicked for:', item.name, 'type:', item.type);
            setShowMenu(!showMenu);
          }}
          title="Options"
        >
          â‹®
        </button>

        {/* Context menu - show different options based on type */}
        {showMenu && (
          <div 
            className="tree-context-menu" 
            onClick={(e) => e.stopPropagation()}
            onMouseLeave={() => setShowMenu(false)}
          >
            {/* Rename - available for both folders and documents */}
            <button 
              onClick={(e) => {
                e.stopPropagation();
                console.log('Rename clicked for:', item.name, 'type:', item.type);
                setIsRenaming(true);
                setShowMenu(false);
              }}
            >
              âœï¸ Rename
            </button>

            {/* New Document - only for folders */}
            {isFolder && (
              <button 
                onClick={(e) => {
                  e.stopPropagation();
                  handleCreateDocInFolder(e);
                }}
              >
                â• New Document
              </button>
            )}

            {/* Delete - available for both folders and documents */}
            <button 
              onClick={(e) => {
                e.stopPropagation();
                console.log('Delete clicked for:', item.name, 'type:', item.type);
                handleDelete();
              }} 
              className="danger"
            >
              ğŸ—‘ï¸ Delete
            </button>
          </div>
        )}
      </div>

      {isFolder && isExpanded && item.children && item.children.length > 0 && (
        <div className="tree-children">
          {item.children.map((child) => (
            <TreeItem
              key={`${child.type || 'item'}-${child.id}`}
              item={child}
              level={level + 1}
              onDocumentSelect={onDocumentSelect}
              onCreateDocument={onCreateDocument}
              onDeleteDocument={onDeleteDocument}
              onDeleteFolder={onDeleteFolder}
              onRenameDocument={onRenameDocument}
              onRenameFolder={onRenameFolder}
              onMoveDocument={onMoveDocument}
              currentDocumentId={currentDocumentId}
            />
          ))}
        </div>
      )}
    </div>
  );
}
